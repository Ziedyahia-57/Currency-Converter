name: Process Exchange Rate Averages
on:
  schedule:
    - cron: '30 00 * * *'  # 00:30 AM UTC daily
  workflow_dispatch:
  workflow_run:
    workflows: [Update Currency Rates]
    types:
      - completed

jobs:
  process-averages:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Verify data.json exists
        id: check-data
        run: |
          if [ -f "data.json" ]; then
            echo "data.json found"
            if jq empty data.json 2>/dev/null; then
              echo "data_valid=true" >> $GITHUB_OUTPUT
              echo "timestamp=$(jq -r '.timestamp // empty' data.json)" >> $GITHUB_OUTPUT
            else
              echo "data_valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "data_valid=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Run processor
        if: steps.check-data.outputs.data_valid == 'true'
        id: process
        run: |
          echo "Running monthly averages processor..."
          
          # Run the processor (using the separate file)
          node monthly-data-processor.js
          
          # Check if processed data was created
          if [ -f "processed-data.json" ]; then
            echo "data_file=processed-data.json" >> $GITHUB_OUTPUT
            
            # Get processed data info
            PROCESSED_DATE=$(node -e "console.log(require('./processed-data.json').metadata.date || '')")
            CURRENCY_COUNT=$(node -e "console.log(Object.keys(require('./processed-data.json').data || {}).length || 0)")
            
            # Count total data points
            ROLLING_POINTS=$(node -e "
              const data = require('./processed-data.json').data || {};
              const total = Object.values(data).reduce((sum, arr) => sum + arr.length, 0);
              console.log(total);
            ")
            
            echo "rolling_data_points=$ROLLING_POINTS" >> $GITHUB_OUTPUT
            echo "current_date=$PROCESSED_DATE" >> $GITHUB_OUTPUT
            echo "currency_count=$CURRENCY_COUNT" >> $GITHUB_OUTPUT
            
            echo "‚úì Data processing successful"
            echo "  Date: $PROCESSED_DATE"
            echo "  Currencies: $CURRENCY_COUNT"
            echo "  Data points: $ROLLING_POINTS"
          else
            echo "‚ùå processed-data.json was not created"
            exit 1
          fi
          
      - name: Create summary markdown
        if: steps.process.outputs.data_file
        run: |
          echo "Creating summary markdown..."
          
          # Simple Node script for summary
          node -e "
          const fs = require('fs');
          
          function createSummary() {
              try {
                  // Read processed data
                  const processedData = JSON.parse(fs.readFileSync('processed-data.json', 'utf8'));
                  
                  // Read input data
                  let inputData = {};
                  try {
                      inputData = JSON.parse(fs.readFileSync('data.json', 'utf8'));
                  } catch(e) {
                      console.log('Note: Could not read data.json');
                  }
                  
                  // Create markdown
                  let markdown = '# Exchange Rate Averages\\n\\n';
                  markdown += '**Last Updated:** ' + (processedData.metadata.date || 'Unknown') + '\\n';
                  markdown += '**Base Currency:** ' + (inputData.base || 'USD') + '\\n';
                  markdown += '**Currencies Tracked:** ' + Object.keys(processedData.data || {}).length + '\\n';
                  
                  // Count total data points
                  const totalPoints = Object.values(processedData.data || {}).reduce((sum, arr) => sum + arr.length, 0);
                  markdown += '**Total Data Points:** ' + totalPoints + '\\n\\n';
                  
                  markdown += '## Current Rates (Today)\\n\\n';
                  markdown += '| Currency | Rate |\\n';
                  markdown += '|----------|------|\\n';
                  
                  const majorCurrencies = ['EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CNY', 'CHF', 'INR', 'BRL', 'MXN'];
                  
                  // Get today's date
                  const today = processedData.metadata.date || '';
                  
                  majorCurrencies.forEach(currency => {
                      if (processedData.data[currency]) {
                          // Find today's rate
                          const todayEntry = processedData.data[currency].find(entry => entry.date === today);
                          if (todayEntry) {
                              markdown += '| ' + currency + ' | ' + todayEntry.value.toFixed(6) + ' |\\n';
                          } else {
                              // Use latest if today not found
                              const latest = processedData.data[currency][processedData.data[currency].length - 1];
                              if (latest) {
                                  markdown += '| ' + currency + ' | ' + latest.value.toFixed(6) + ' (latest) |\\n';
                              }
                          }
                      }
                  });
                  
                  markdown += '\\n## Data Collection Status\\n\\n';
                  markdown += 'Rolling 30-day coverage:\\n\\n';
                  
                  majorCurrencies.forEach(currency => {
                      if (processedData.data[currency]) {
                          const count = processedData.data[currency].length;
                          const coverage = Math.round((count / 30) * 100);
                          markdown += '- ' + currency + ': ' + count + '/30 days (' + coverage + '% coverage)\\n';
                      }
                  });
                  
                  fs.writeFileSync('AVERAGES_SUMMARY.md', markdown);
                  console.log('Summary created: AVERAGES_SUMMARY.md');
                  
              } catch (error) {
                  console.error('Error creating summary:', error.message);
              }
          }
          
          createSummary();
          "
          
      - name: Commit processed data
        if: steps.process.outputs.data_file
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add processed-data.json AVERAGES_SUMMARY.md
          
          if ! git diff --cached --quiet; then
            TODAY="${{ steps.process.outputs.current_date }}"
            ROLLING_POINTS="${{ steps.process.outputs.rolling_data_points }}"
            CURRENCY_COUNT="${{ steps.process.outputs.currency_count }}"
            
            COMMIT_MSG="üìä Update currency averages for $TODAY
            
            ‚Ä¢ Rolling 30-day data: $ROLLING_POINTS points
            ‚Ä¢ Currencies tracked: $CURRENCY_COUNT
            ‚Ä¢ Automated update
            
            [skip ci]"
            
            git commit -m "$COMMIT_MSG"
            git push
          else
            echo "No changes to commit"
          fi
          
      - name: Handle missing data
        if: steps.check-data.outputs.data_valid != 'true'
        run: |
          echo "‚ö†Ô∏è No valid data found, skipping processing"
          echo "This is normal if the Update Currency Rates workflow hasn't run yet."
          exit 0

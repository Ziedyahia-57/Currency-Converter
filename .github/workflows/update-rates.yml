- name: Fetch exchange rates
  id: fetch
  env:
    API_KEY: ${{ secrets.EXCHANGERATE_API_KEY }}
  run: |
    # Fetch with error handling
    if ! curl -sSf --retry 3 --max-time 10 \
      "https://api.exchangerate.host/live?access_key=$API_KEY" > response.json; then
      echo "::error::Failed to fetch from API"
      exit 1
    fi

    # Process response - remove USD prefix and add USD=1
    if ! jq -e '
      if .success == true then {
        disclaimer: "Data sourced from exchangerate.host",
        timestamp: (.timestamp|todate),
        rates: { USD: 1 } + (.quotes | with_entries(.key |= sub("^USD"; "")))
      } else error("API error: \(.error.type)") end
    ' response.json > data.json; then
      echo "::error::Invalid API response structure"
      cat response.json
      exit 1
    fi
